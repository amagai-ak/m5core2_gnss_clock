# M5Stack Core2 + GNSSモジュールで作る時計&ロガー

VSCode + PlatformIO用．LVGLは9.2を使用．

Module GNSSはこちら
https://docs.m5stack.com/ja/module/GNSS%20Module

![SCREEN](screen.png)

時刻はRTCにも保存しているので，次回起動時にはGNSSを受信できなくても一応時刻は表示される．

GNSSで時刻同期が出来るまでは，時計の文字は赤くなっている．

画面右下の丸いLED風のものは，1PPS入力があると点滅する．ここが点滅していれば正常に測位ができている状態．点滅していない状態では時計は信用できない．

## SDカードへの記録

起動時にSDカードが挿入されていた場合，次の3つのデータが記録される．
* NMEAメッセージ(GPSの出力全部)
* 位置データ (GGAメッセージから抽出, 1Hz)
* IMUデータ (10Hz)

ただし，時刻同期が出来るまでは記録は開始されない．

SDカードは，FAT32でフォーマットされた16G以下のサイズのカードであること．

ファイル名は，記録開始時の日付と時刻から生成される．

記録中にSDカードを抜かないこと．抜く場合はシャットダウンを行って，電源を切ってから抜く．

記録が行われている状態では，衛星配置図の下にRecという文字が現れる．
この領域がグレーになっている場合は，SDカードが認識されていないか，書き込み中にエラーが発生して記録が中止されている．SDカードの確認が必要．

### 位置データの記録形式

データは次のような並びで記録される．
```text
日付時刻(UTC), 緯度，経度, 高度, 測位モード, 測位衛星数, HDOP
```

日付時刻は，ISO 8601形式．例："2025-09-20T05:51:27.000Z"

測位モードの数字の意味は以下の通り．
|数字|意味|
|---|---|
|0|測位不能|
|1|単独測位(SPS)|
|2|Differential|
|4|RTK-Fix|
|5|RTK-Float|

### IMUデータの記録形式

データは次のような並びで記録される
```text
タイムスタンプ, カウント，加速度X, 加速度Y, 加速度Z, 角速度X, 角速度Y, 角速度Z, 磁気x, 磁気y, 磁気z
```

タイムスタンプはunixtimeで小数点以下6桁．
カウントはuint32_tで，32bit分カウントアップすると0に戻る．

## シャットダウン方法

画面を左にスワイプするか，Cボタンを押すとシャットダウン画面に遷移する．
SDカードにデータを記録している場合には，いきなり電源を切るのではなく，必ずシャットダウン画面から電源を切ること．

SDカードを挿入していない場合は，いきなり電源を切っても構わない．

## GNSS基板のディップスイッチの設定

以下の接続になるように設定する．

* PPS: GPIO35
* TX: GPIO14
* RX: GPIO13

![DIP-SW](dipsw.png)

赤枠のスイッチがON

## u-centerでの操作

シリアルポートから入力されたデータがそのままNEO-M9Nに送られる．また，NEO-M9Nからのデータがそのままシリアルに出力されるので，u-centerをそのまま利用できる．
u-centerの通信レートを115200bpsに設定し，ポートをM5Stackが接続されているポートにすれば，M5StackがGNSSモジュールとして見える．
ただし，シリアルポートの通信レートに注意．PC-M5Stack間は115200bps, M5Stack-NEO 間は38400bpsに固定されているので，
u-centerで通信レートを変更すると通信できなくなる．

## 使用しているフォント

https://fonts.google.com/specimen/Open+Sans

